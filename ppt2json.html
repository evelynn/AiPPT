<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ppt2json</title>
    <link rel="stylesheet" href="static/jsoneditor.min.css">
    <script src="static/jsoneditor.min.js"></script>
    <style>
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
            background-color: #fff;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #c1c1c1;
        }
        .docmee {
            z-index: 9999;
            background-image: linear-gradient(to left, rgb(107, 90, 196), rgb(96, 84, 189));
            background-clip: text;
            color: transparent;
            font-weight: bold;
            display: inline-block;
            font-size: 1.125rem;
            line-height: 1.75rem;
            user-select: none;
            cursor: pointer;
            position: fixed;
            top: 10px;
            left: 15px;
        }
        #json {
            padding: 10px;
        }
        .jsoneditor-mode-view {
            border: 2px solid #ddd;
        }
        .jsoneditor-menu {
            display: none;
        }
        .jsoneditor-navigation-bar {
            display: none;
        }
        .jsoneditor-outer.has-nav-bar.has-main-menu-bar {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        #pageList {
            list-style-type: none;
        }
        #pageList li {
            display: inline;
            padding: 1px 4px;
            margin-left: 8px;
            cursor: pointer;
        }
        .selected {
            color: green;
            border: 1px solid green;
        }
        #container > svg {
            border: 1px solid #ccc;
        }
    </style>
</head>
<body style="margin: 20px">
    <a href="https://docmee.cn" target="_blank" class="docmee" title="Enter DocMee AiPPT official website">DocMee AiPPT</a>
    <div style="margin-top: 50px;">
        <input id="file" type="file" accept="application/vnd.openxmlformats-officedocument.presentationml.presentation, application/json" onclick="document.getElementById('file').value = ''" onchange="ppt2json()" />
        <span id="refresh_json" style="color: #999;cursor: pointer;margin-right: 15px;" title="Refresh JSON data" onclick="refreshJson()">Refresh</span>
        <!-- <span id="download_json" style="color: #317ef3;display: none;cursor: pointer;margin-right: 15px;" title="Download json data" onclick="downloadJson()">Download json file</span> -->
        <span id="download_pptx" style="color: #317ef3;display: none;cursor: pointer;" title="Render and download pptx" onclick="json2ppt()">Render and download pptx</span>
    </div>
    <div id="json" style="margin-top: 20px"></div>
    <div>
        <ul id="pageList"></ul>
        <span>Edit Mode:</span>
        <input id="mode_checkbox" type="checkbox" checked onchange="changeMode()" />
        <select id="insert_element" style="display: none;margin-left: 10px" onchange="insertElement(this.value.split(',')[0], this.value.split(',')[1])">
            <option value="">-- Insert Element --</option>
            <option value="text,title1">Insert Title</option>
            <option value="text,title2">Insert Subtitle</option>
            <option value="text,content">Insert Body Text</option>
            <option value="image">Insert Image</option>
            <option value="geometry">Insert Random Shape</option>
            <option value="table">Insert Table</option>
            <option value="chart,bar">Insert Bar Chart</option>
            <option value="chart,pie">Insert Pie Chart</option>
            <option value="chart,doughnut">Insert Doughnut Chart</option>
            <option value="chart,line">Insert Line Chart</option>
        </select>
    </div>
    <div id="container" style="margin-top: 10px;">
        <svg id="ppt_svg"></svg>
    </div>
</body>
<script src="static/chart.js"></script>
<script src="static/geometry.js"></script>
<script src="static/ppt2svg.js"></script>
<script src="static/element.js"></script>
<script>
    const apiKey = '4u2Fo50Alk1ym2Os'
    var editor = new JSONEditor(document.querySelector('#json'), {}, {})

    var pptxObj = null
    var selectIdx = 0
    var mTimer = null
    var ppt2svg = new Ppt2Svg('ppt_svg', 960, 540)

    function ppt2json() {
	if (true) {
	  alert('This feature is temporarily disabled. Please use the DocMee AiPPT Open Platform: https://docmee.cn/open-platform');
	  return;
	}
        let file = document.getElementById('file').files[0]
        if (file.name.endsWith('.json')) {
            let reader = new FileReader()
            reader.onload = function(e) {
                let json = e.target.result
                let pptxObj = JSON.parse(json)
                editor.set(pptxObj)
                drawPageList(pptxObj)
            }
            reader.onerror = function(e) {
                editor.set({ message: 'Read error: ' + e.target.error })
            }
            reader.readAsText(file)
            return
        }
        if (file.size > 1048576 * 50) {
          alert('File cannot exceed 50M')
          return
        }
        if (file) {
            let formData = new FormData()
            formData.append('file', file)
            let xhr = new XMLHttpRequest()
            xhr.open('POST', 'https://docmee.cn/api/public/ppt/ppt2json?apiKey=' + apiKey)
            editor.set({ message: 'Parsing, please wait...' })
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        // Parse
                        let pptxObj = JSON.parse(xhr.responseText)
                        if (pptxObj.code == -1 && pptxObj.message) {
                            alert(pptxObj.message)
                            return
                        }
                        editor.set(pptxObj)
                        drawPageList(pptxObj)
                    } else {
                        editor.set({ message: 'http status: ' + xhr.status })
                    }
                }
            }
            xhr.send(formData)
        } else {
            editor.set({ message: 'Please select a file' })
        }
    }

    function json2ppt() {
        if (!pptxObj) {
            return
        }
        // Render and download pptx
        if (download_pptx.innerText.indexOf('download') == -1) {
            return
        }
        download_pptx.innerText = 'Rendering...'
        let xhr = new XMLHttpRequest()
        xhr.responseType = 'blob'
        xhr.open('POST', 'https://docmee.cn/api/public/ppt/json2ppt?apiKey=' + apiKey)
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.onload = function() {
            if (this.status == 200) {
                download_pptx.innerText = 'Render and download pptx'
                let blob = this.response
                if (blob.type == 'application/json') {
                    const reader = new FileReader()
                    reader.onload = function(e) {
                        let json = JSON.parse(e.target.result)
                        alert('Download failed: ' + json.message)
                    }
                    reader.readAsText(blob)
                    return
                }
                let a = document.createElement('a')
                a.href = window.URL.createObjectURL(blob)
                let name = 'download'
                let file = document.getElementById('file').files[0]
                if (file) {
                    name = file.name.replace('.pptx', '').replace('.json', '')
                }
                a.download = name + '.pptx'
                a.click()
            }
        }
        xhr.send(JSON.stringify(pptxObj))
    }

    function downloadJson() {
        if (!pptxObj) {
            return
        }
        let urlObject = window.URL || window.webkitURL || window
        let export_blob = new Blob([JSON.stringify(pptxObj)])
        let save_link = document.createElement('a')
        save_link.href = urlObject.createObjectURL(export_blob)
        let name = 'download'
        let file = document.getElementById('file').files[0]
        if (file) {
            name = file.name.replace('.pptx', '').replace('.json', '')
        }
        save_link.download = name + '.json'
        save_link.click()
    }

    function drawPageList(_pptxObj) {
        counter = 0
        selectIdx = 0
        imageCache = {}
        pptxObj = _pptxObj
        document.getElementById('download_json').style.display = 'inline'
        document.getElementById('download_pptx').style.display = 'inline'
        document.getElementById('insert_element').style.display = document.getElementById('mode_checkbox').checked ? 'inline-block' : 'none'
        let pageList = document.getElementById('pageList')
        pageList.innerHTML = '';
        for (let i = 0; i < pptxObj.pages.length; i++) {
            let page = pptxObj.pages[i]
            let li = document.createElement('li')
            li.id = 'li_' + i
            li.innerText = i + 1 + ''
            li.addEventListener('click', () => {
                document.getElementById('li_' + selectIdx).classList.remove('selected')
                selectIdx = i
                li.classList.add('selected')
                ppt2svg.drawPptx(pptxObj, selectIdx)
            })
            if (i == selectIdx) {
                li.classList.add('selected')
            }
            pageList.appendChild(li)
        }
        ppt2svg.drawPptx(pptxObj, selectIdx)
    }

    function refreshJson() {
        pptxObj = editor.get()
        ppt2svg.drawPptx(pptxObj, selectIdx)
    }

    function changeMode() {
        ppt2svg.setMode(document.getElementById('mode_checkbox').checked ? 'edit' : 'view')
        document.getElementById('insert_element').style.display = pptxObj && document.getElementById('mode_checkbox').checked ? 'inline-block' : 'none'
    }

    ppt2svg.onchange = (elementObj) => {
        editor.set(pptxObj)
    }

    changeMode()

    function insertElement(type, subType) {
        let element = null
        if (type == 'text') {
            // Text
           element = createTextBox(subType)
        } else if (type == 'image') {
            // Image
            let input = document.createElement('input')
            input.type = 'file'
            input.accept = '.jpg,.png'
            input.onchange = function(e1) {
                const file = e1.target.files[0]
                if (!file) return
                const reader = new FileReader()
                reader.onload = function(e2) {
                    const base64 = e2.target.result
                    const img = new Image()
                    img.src = base64
                    img.onload = function() {
                        const width = img.width > 300 ? 300 : img.width
                        const height = img.height * (width / img.width)
                        element = createImage(base64, width, height)
                        pptxObj.pages[selectIdx].children.push(element)
                        ppt2svg.drawPptx(pptxObj, selectIdx)
                    }
                }
                reader.readAsDataURL(file)
            }
            input.click()
        } else if (type == 'geometry') {
            // Shape
            let geometryName = subType
            if (!geometryName) {
                // Random shape
                let keys = Object.keys(geometryMap)
                geometryName = keys[Math.floor(Math.random() * keys.length)]
                console.log('geometry', geometryName)
            }
            element = createGeometry(geometryName)
        } else if (type == 'table') {
            // Table
            let rowColumnDataList = [['Row 1 Col 1', 'Row 1 Col 2', 'Row 1 Col 3'], ['Row 2 Col 1', 'Row 2 Col 2', 'Row 2 Col 3'], ['Row 3 Col 1', 'Row 3 Col 2', 'Row 3 Col 3']]
            element = createTable(rowColumnDataList)
        } else if (type == 'chart') {
            // Chart
            let rowColumnDataList = []
            if (subType == 'pie' || subType == 'doughnut') {
                rowColumnDataList = [[' ', 'Sales'], ['Q1', '8.2'], ['Q2', '3.2'], ['Q3', '1.4'], ['Q4', '1.2']]
            } else {
                rowColumnDataList = [[' ', 'Series 1', 'Series 2', 'Series 3'], ['Category 1', '4.3', '2.4', '2'], ['Category 2', '2.5', '4.4', '2'], ['Category 3', '3.5', '1.8', '3'], ['Category 4', '4.5', '2.8', '5']]
            }
            element = createChart('Chart Title', subType, rowColumnDataList)
        }
        if (element) {
            pptxObj.pages[selectIdx].children.push(element)
            ppt2svg.drawPptx(pptxObj, selectIdx)
        }
        document.getElementById('insert_element').value = ''
    }
</script>
</html>
